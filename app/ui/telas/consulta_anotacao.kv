#:import hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp

<ConsultaAnotacaoScreen>:
    name: "consulta_anotacao"
    
    MDFloatLayout:
        md_bg_color: hex("#F5F7F6")

        # --- Cabeçalho ---
        MDBoxLayout:
            orientation: "horizontal"
            adaptive_height: True
            padding: "16dp"
            spacing: "12dp"
            pos_hint: {"top": 1}
            md_bg_color: hex("#92C7A3")
            radius: [0, 0, 0, 30]
            elevation: 2

            MDIconButton:
                icon: "arrow-left"
                theme_icon_color: "Custom"
                icon_color: 1, 1, 1, 1
                pos_hint: {"center_y": .5}
                on_release: app.root.current = "home_psicologo"

            MDLabel:
                text: "Nova Anotação"
                font_style: "Title"
                role: "large"
                theme_text_color: "Custom"
                text_color: 1, 1, 1, 1
                pos_hint: {"center_y": .5}

        # --- Conteúdo ---
        MDScrollView:
            pos_hint: {"top": .88}
            
            MDBoxLayout:
                orientation: "vertical"
                adaptive_height: True
                padding: "20dp"
                spacing: "20dp"

                # --- CORREÇÃO AQUI: Botão Seletor com MDButtonText ---
                MDButton:
                    id: btn_selecionar_paciente
                    style: "elevated"
                    # Removemos a propriedade 'text' daqui de cima, ela não faz nada sozinha
                    size_hint_x: 1
                    height: "56dp"
                    theme_bg_color: "Custom"
                    md_bg_color: hex("#E8E8E8")
                    
                    # Abre o menu ao clicar
                    on_release: root.menu.open() if root.menu else None

                    # O Texto precisa ser um widget filho no KivyMD 2.0
                    MDButtonText:
                        id: lbl_btn_paciente # Demos um ID para alterar via Python
                        text: "Selecione o Paciente..."
                        theme_text_color: "Custom"
                        text_color: 0, 0, 0, 0.8
                        pos_hint: {"center_x": .5, "center_y": .5}

                # --- 2. Campo de Texto ---
                MDTextField:
                    id: anotacao_input
                    mode: "outlined"
                    multiline: True
                    size_hint_y: None
                    height: "150dp"
                    max_text_length: 500
                    
                    MDTextFieldHintText:
                        text: "Detalhes da consulta..."

                    MDTextFieldMaxLengthText:
                        max_text_length: 500

                # --- 3. Botão Salvar ---
                MDButton:
                    style: "filled"
                    size_hint_x: 1
                    theme_bg_color: "Custom"
                    md_bg_color: hex("#92C7A3")
                    on_release: root.salvar_anotacao()

                    MDButtonText:
                        text: "Salvar no Histórico"
                        theme_text_color: "Custom"
                        text_color: 1, 1, 1, 1
                        pos_hint: {"center_x": .5, "center_y": .5}

                MDDivider:
                    height: "2dp"

                MDLabel:
                    text: "Histórico Recente"
                    font_style: "Title"
                    role: "small"
                    theme_text_color: "Secondary"

                # --- 4. Lista de Histórico ---
                MDList:
                    id: lista_historico
                    spacing: "10dp"
                
                Widget:
                    size_hint_y: None
                    height: "100dp"